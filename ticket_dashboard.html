<!-- This file includes the all resort ticket leaderboard and tickets by priority
for both MMSA and BBMR -->
<style media="screen">
  h1 {
    text-align: center;
  }
  .super-duper-container {
    display: flex;
    flex-wrap: wrap;
  }
  .super-column {
    width: 33%;
  }
  #leader-board {
    width: 465px;
  }
  .container {
    display: flex;
    flex-wrap: wrap;
  }
  .p_box {
    margin: 2px;
    /*border: 2px solid #aaa;*/
    background-color: #eaeaea;
    width: 23%;
    font-family: Arial, sans-serif;
    font-size: 16px;
    font-weight: 800;
    text-align: center;
  }
  .pie-chart {
    margin: auto;
    text-align: center;
  }
  .priority {
    color: #fff;
    padding: 1em;
  }
  .critical {
    background-color: #FF1C09;
  }
  .high {
    background-color: #E87008;
  }
  .medium {
    background-color: #FFC503;
  }
  .low {
    background-color: #CDE808;
  }
  @media (max-width: 720px) {
    .p_box {
      width: 48%;
    }
  }
  @media (max-width: 400px) {
    .p_box {
      width: 99%;
    }
  }
  .piste {
    min-height: 50px;
    min-width: 450px;
    margin: 2px;
    padding: 5px;
    border: none;
    border-radius: 5px;
    float: left;
    width: 23%;
    color: #fff;
    font-family: times, serif;
    font-size: 22px;
    font-weight: 800;
    text-transform: uppercase;
  }
  .super-container {
    display: flex;
    flex-direction: column;
    max-width: 500px;
    margin: auto;
  }
  .container {
    display: flex;
    align-items: center;
  }
  .icon {
    padding: 5px;
    margin-left: 0.5em;
    background-color: #fefefe;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  .black-diamond {
    background-color: #111;
  }
  .blue-square {
    background-color: #2828ff;
  }
  .green-circle {
    background-color: green;
  }
  .names {
    border-left: 1px #fff solid;
    margin: 0 1em;
    padding: 0 1em;
  }
  .bd-icon {
     width: 20px;
     height: 20px;
     background: black;
     margin: 9px 0 0 20px;
     /* Rotate */
     -webkit-transform: rotate(-45deg);
     -moz-transform: rotate(-45deg);
     -ms-transform: rotate(-45deg);
     -o-transform: rotate(-45deg);
     transform: rotate(-45deg);
     /* Rotate Origin */
     -webkit-transform-origin: 0 100%;
     -moz-transform-origin: 0 100%;
     -ms-transform-origin: 0 100%;
     -o-transform-origin: 0 100%;
     transform-origin: 0 100%;
  }
  .dbl-black {
    display: flex;
    flex-direction: row;
    margin-bottom: 2px;
  }
  .bd-icon-small {
    width: 15px;
    height: 15px;
  }
  .bs-bd-icon {
    margin-left: 15px;
  }
  .small-text {
    color: #000;
    font-size: .3em;
  }
  .bs-icon {
    width: 30px;
    height: 30px;
    background: #2828ff;
  }
  .gc-icon {
    width: 24px;
    height: 24px;
    margin: 3px;
    background: green;
    -moz-border-radius: 15px;
    -webkit-border-radius: 15px;
    border-radius: 15px;
  }
  @media (max-width: 720px) {
    .piste {
      width: 48%;
    }
  }
  @media (max-width: 400px) {
    .piste {
      width: 99%;
    }
  }
</style>


<div class="super-duper-container">
  <div class="super-column" id="leader-board">
    <h1>Monthly Ticket Leaderboard</h1>
    <div class="super-container">
      <div class="piste container black-diamond" id="container">
        <div class="icon">
          <div class="dbl-black">
            <div class="bd-icon bd-icon-small"></div><div class="bd-icon bd-icon-small"></div>
          </div>
          <div class="small-text">Experts Only</div>
        </div>
        <div class="names" id="dbl-black-diamond">
          Loading...
        </div>
      </div>
      <div class="piste container black-diamond" id="container">
        <div class="icon">
          <div class="bd-icon"></div>
        </div>
        <div class="names" id="black-diamond">
          Loading...
        </div>
      </div>
      <div class="piste container blue-square" id="container">
        <div class="icon">
          <div class="bs-icon"><div class="bd-icon bs-bd-icon"></div></div>
        </div>
        <div class="names" id="blue-black-diamond">
          Loading...
        </div>
      </div>
      <div class="piste container blue-square" id="container">
        <div class="icon">
          <div class="bs-icon"></div>
        </div>
        <div class="names" id="blue-square">
          Loading...
        </div>
      </div>
      <div class="piste container green-circle" id="container">
        <div class="icon">
          <div class="bs-icon"><div class="gc-icon"></div></div>
        </div>
        <div class="names" id="blue-green-circle">
          Loading...
        </div>
      </div>
      <div class="piste container green-circle" id="container">
        <div class="icon">
          <div class="gc-icon"></div>
        </div>
        <div class="names" id="green-circle">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <div class="super-column" id="mmsa-tickets">
    <h1>MMSA Ticket Count by Priority</h1>
    <div class="container">
      <div class="p_box">
        <div class="critical priority">Critical Priority</div>
        <p id="mmsa_critical_priority">Loading...</p>
      </div>
      <div class="p_box">
        <div class="high priority">High Priority</div>
        <p id="mmsa_high_priority">Loading...</p>
      </div>
      <div class="p_box">
        <div class="medium priority">Medium Priority</div>
        <p id="mmsa_medium_priority">Loading...</p>
      </div>
      <div class="p_box">
        <div class="low priority">Low Priority</div>
        <p id="mmsa_low_priority">Loading...</p>
      </div>
      <div class="pie-chart">
        <h1>MMSA Tickets by Business Unit</h1>
        <h4>Last 30 days</h4>
        <canvas id="mmsaBusUnit" width="400" height="400"></canvas>
      </div>
      <div class="pie-chart">
        <h1>MMSA Tickets by Issue</h1>
        <h4>Last 30 days</h4>
        <canvas id="mmsaIssue" width="400" height="400"></canvas>
      </div>
      <div class="pie-chart">
        <h1>MMSA Tickets by Site</h1>
        <h4>Last 30 days</h4>
        <canvas id="mmsaSite" width="400" height="400"></canvas>
      </div>
    </div>
  </div>


  <div class="super-column" id="bbmr-tickets">
    <h1>BBMR Ticket Count by Priority</h1>
    <div class="container">
      <div class="p_box">
        <div class="critical priority">Critical Priority</div>
        <p id="bbmr_critical_priority">Loading...</p>
      </div>
      <div class="p_box">
        <div class="high priority">High Priority</div>
        <p id="bbmr_high_priority">Loading...</p>
      </div>
      <div class="p_box">
        <div class="medium priority">Medium Priority</div>
        <p id="bbmr_medium_priority">Loading...</p>
      </div>
      <div class="p_box">
        <div class="low priority">Low Priority</div>
        <p id="bbmr_low_priority">Loading...</p>
      </div>
      <div class="pie-chart">
        <h1>BBMR Tickets by Business Unit</h1>
        <h4>Last 30 days</h4>
        <canvas id="bbmrBusUnit" width="400" height="400"></canvas>
      </div>
      <div class="pie-chart">
        <h1>BBMR Tickets by Issue</h1>
        <h4>Last 30 days</h4>
        <canvas id="bbmrIssue" width="400" height="400"></canvas>
      </div>

      <!-- Begin Spencer's crappy Javascript -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js" charset="utf-8"></script>
      <script>
        // Configuration variables
        var updateInterval = 60000; // How frequently to update ticket counts, in milliseconds
        var startOfMonth = getTheFirst();
        var topCount = 7; // How many rankings to have. ie. top 3, top 5 closers, etc.
        var mmsaLocationFilter = "(Site0 ne 'BBMR - Snow Summit') and (Site0 ne 'BBMR - Bear Mountain')";
        var bbmrLocationFilter = "(startswith(Site0,'BBMR'))";

        setInterval(updateCloserCount, updateInterval);
        setInterval(updateTicketCount(mmsaLocationFilter, "mmsa"), updateInterval);
        setInterval(updateTicketCount(bbmrLocationFilter, "bbmr"), updateInterval);
        setInterval(updateBusUnitCount(mmsaLocationFilter, "mmsaBusUnit"), updateInterval);
        setInterval(updateBusUnitCount(bbmrLocationFilter, "bbmrBusUnit"), updateInterval);
        setInterval(updateGroupCount(mmsaLocationFilter, "Issue", "mmsaIssue"), updateInterval);
        setInterval(updateGroupCount(bbmrLocationFilter, "Issue", "bbmrIssue"), updateInterval);
        setInterval(updateGroupCount(mmsaLocationFilter, "Site0", "mmsaSite"), updateInterval);
        updateCloserCount();
        updateTicketCount(mmsaLocationFilter, "mmsa");
        updateTicketCount(bbmrLocationFilter, "bbmr");
        updateBusUnitCount(mmsaLocationFilter, "mmsaBusUnit");
        updateBusUnitCount(bbmrLocationFilter, "bbmrBusUnit");
        updateGroupCount(bbmrLocationFilter, "Issue", "bbmrIssue");
        updateGroupCount(mmsaLocationFilter, "Issue", "mmsaIssue");
        updateGroupCount(mmsaLocationFilter, "Site0", "mmsaSite");


        var employees = [
          {
            name: "Craig Lindstrom",
            ids: [1055, 947],
            count: 0
          },
          {
            name: "Ben Brissey",
            ids: [1470, 1309],
            count: 0
          },
          {
            name: "Mike Mossman",
            ids: [1405, 1110],
            count: 0
          },
          {
            name: "Roger Vieau",
            ids: [1466, 1280],
            count: 0
          },
          {
            name: "Spencer Stewart",
            ids: [1493],
            count: 0
          },
          {
            name: "Matt Berman",
            ids: [1153],
            count: 0
          },
          {
            name: "Randy Brodrick",
            ids: [23],
            count: 0
          },
          {
            name: "Bruce Burton",
            ids: [1],
            count: 0
          },
          {
            name: "David Childs",
            ids: [177],
            count: 0
          },
          {
            name: "Matt Clausen",
            ids: [462],
            count: 0
          },
          {
            name: "Casey Cordi",
            ids: [828],
            count: 0
          },
          {
            name: "Ric Dean",
            ids: [20],
            count: 0
          },
          {
            name: "James Delmarto",
            ids: [687],
            count: 0
          },
          {
            name: "Jeff Donze",
            ids: [95],
            count: 0
          },
          {
            name: "Sam Elachkar",
            ids: [1403],
            count: 0
          },
          {
            name: "Morgan Faggianelli",
            ids: [332],
            count: 0
          },
          {
            name: "Juan Garcia",
            ids: [19],
            count: 0
          },
          {
            name: "Tom Keese",
            ids: [202],
            count: 0
          },
          {
            name: "Chad Lawver",
            ids: [1644],
            count: 0
          },
          {
            name: "Lea Martin",
            ids: [103],
            count: 0
          },
          {
            name: "Michael Payne",
            ids: [186],
            count: 0
          },
          {
            name: "Chris Robinette",
            ids: [17],
            count: 0
          },
          {
            name: "Al Rubalcava",
            ids: [262],
            count: 0
          },
          {
            name: "Michelle Selander",
            ids: [282],
            count: 0
          },
          {
            name: "James Shoshone",
            ids: [189],
            count: 0
          }
        ];

        // Returns 'counts' object with {emp ID: ticket count}
        function updateCloserCount() {
          $.ajax({
            url: "http://webshare/departments/it/_api/Lists/getbytitle('IT%20Helpdesk')/items?$top=600&select=AssignedToId&$filter=(Modified ge datetime'" + startOfMonth + "') and (OData__Status eq 'Closed')",
            type: "GET",
            dataType: "json",
            timeout: 5000,
            headers: {
                accept: "application/json;odata=verbose",
                contentType: "application/json;odata=verbose"
            },
            success: function (data) {
              var indCounts = {}; // Empty object for indCounts.
              var results = data.d.results;
              for (var i = 0; i < results.length; i++) {
                var result = results[i];
                // Count up individuals closing tickets
                individualsAssigned = result.AssignedToId.results;
                for (var j = 0; j < individualsAssigned.length; j++) {
                  var individual = individualsAssigned[j];
                  // Increment the count for that individual.
                  indCounts[individual] = indCounts[individual] ? indCounts[individual]+1 : 1;
                }
              }
              resetCount(employees);
              assignCount(indCounts);
              var sortedByCount = sortByCount(employees);
              updateHtml(sortedByCount);
            },
            error: function(data, errorCode, errorMessage) {
              $("#container").html(errorMessage + errorCode);
              console.log("MAJOR ERROR");
            }
          }); // END Ajax call
        } // END getTicketCount();

        // Reset all employee counts to 0
        function resetCount(employees) {
          for (var i = 0; i < employees.length; i++) {
            employees[i].count = 0;
          }
        }

        // Loop through employees & assign tickets closed count
        function assignCount(indCounts) {
          for (var i = 0; i < employees.length; i++) {
            var employeeIds = employees[i].ids;

            // Loop through each employees' ID. Bear people have 2 IDs. Annoying.
            for (var j = 0; j < employeeIds.length; j++) {
              if (employeeIds[j] in indCounts) {
                // Add the count for each ID associated with the employee.
                employees[i].count += indCounts[employeeIds[j]];
              }
            } // End loop through IDs
          } // End loop through employees
        } // End assignCount

        // Sort by greatest ticket count
        function sortByCount(listToSort) {
          var sortedCount = listToSort.slice(0);
          sortedCount.sort(function(a,b) {
            return b.count - a.count;
          });
          return sortedCount;
        }

        function updateHtml(sortedCount) {
          var dbdWinners = "", bdWinners = "", bbdWinners = "", bsWinners = "", bgcWinners = "", gcWinners = "";
          for (var i = 0; i < sortedCount.length; i ++) {
            if (sortedCount[i].count > 49) {
              dbdWinners += "<div>" + sortedCount[i].name + ": " + sortedCount[i].count + "</div>";
            } else if (sortedCount[i].count > 39) {
              bdWinners += "<div>" + sortedCount[i].name + ": " + sortedCount[i].count + "</div>";
            } else if (sortedCount[i].count > 29) {
              bbdWinners += "<div>" + sortedCount[i].name + ": " + sortedCount[i].count + "</div>";
            } else if (sortedCount[i].count > 19) {
              bsWinners += "<div>" + sortedCount[i].name + ": " + sortedCount[i].count + "</div>";
            } else if (sortedCount[i].count > 9) {
              bgcWinners += "<div>" + sortedCount[i].name + ": " + sortedCount[i].count + "</div>";
            } else if (sortedCount[i].count > 0) {
              gcWinners += "<div>" + sortedCount[i].name + ": " + sortedCount[i].count + "</div>";
            }
          }
          $("#dbl-black-diamond").html(dbdWinners);
          $("#black-diamond").html(bdWinners);
          $("#blue-black-diamond").html(bbdWinners);
          $("#blue-square").html(bsWinners);
          $("#blue-green-circle").html(bgcWinners);
          $("#green-circle").html(gcWinners);
        }

        // Ticket Count by Issue, Created in the Last 30 Days
        // Params: location filter (MMSA or BBMR) and the id of the canvas html element
        function updateGroupCount(locationFilter, groupBy, chartId, daysAgo = 30) {
          $.ajax({
            url: "http://webshare/departments/it/_api/Lists/getbytitle('IT%20Helpdesk')/items?$top=300&$filter=(Created ge datetime'" + getDaysAgo(daysAgo) + "') and " + locationFilter,
            type: "GET",
            dataType: "json",
            timeout: 5000,
            headers: {
                accept: "application/json;odata=verbose",
                contentType: "application/json;odata=verbose"
            },
            success: function (data) {
              var groupCounts = {};
              var results = data.d.results;
              console.log(results);
              for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var group = result[groupBy];
                groupCounts[group] = groupCounts[group] ? groupCounts[group]+1 : 1;
              }

              // Sort the business units
              var sortedGroup = Object.keys(groupCounts).sort(function(a,b){return groupCounts[b]-groupCounts[a];});
              var slicedGroup = sortedGroup.slice(0, topCount);
              var otherCount = sortedGroup.length - topCount;
              slicedGroup.push("All Others (" + otherCount + ")");
              var sortedGroupCount = Object.values(groupCounts).sort(function(a,b){return b - a; });
              var slicedGroupCount = sortedGroupCount.slice(0, topCount);
              var theOthers = sortedGroupCount.slice(topCount, sortedGroupCount.length);
              var sumTheOthers = theOthers.reduce(function(a,b){return a+b;});
              slicedGroupCount.push(sumTheOthers);
              makeChart(slicedGroup, slicedGroupCount, chartId);
            },
            error: function(data, errorCode, errorMessage) {
              $("#container").html(errorMessage + errorCode);
              console.log("MAJOR ERROR");
            }
          }); // END Ajax call
        } // END updateBusUnitCount();


        // Ticket Count by Bus Unit, Created in Last 30 Days
        // Params: location filter (MMSA or BBMR) and the id of the canvas html element
        function updateBusUnitCount(locationFilter, chartId, daysAgo = 30) {
          $.ajax({
            url: "http://webshare/departments/it/_api/Lists/getbytitle('IT%20Helpdesk')/items?$top=300&$select=Business_x0020_Unit&$filter=(Created ge datetime'" + getDaysAgo(daysAgo) + "') and " + locationFilter,
            type: "GET",
            dataType: "json",
            timeout: 5000,
            headers: {
                accept: "application/json;odata=verbose",
                contentType: "application/json;odata=verbose"
            },
            success: function (data) {
              var busUnitCounts = {};
              var results = data.d.results;
              for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var busUnit = result.Business_x0020_Unit;
                busUnitCounts[busUnit] = busUnitCounts[busUnit] ? busUnitCounts[busUnit]+1 : 1;
              }

              // Sort the business units
              var sortedBusUnit = Object.keys(busUnitCounts).sort(function(a,b){return busUnitCounts[b]-busUnitCounts[a];});
              var slicedBusUnit = sortedBusUnit.slice(0, topCount);
              var otherCount = sortedBusUnit.length - topCount;
              slicedBusUnit.push("All Others (" + otherCount + ")");
              var sortedBusUnitCount = Object.values(busUnitCounts).sort(function(a,b){return b - a; });
              var slicedBusUnitCount = sortedBusUnitCount.slice(0, topCount);
              var theOthers = sortedBusUnitCount.slice(topCount, sortedBusUnitCount.length);
              var sumTheOthers = theOthers.reduce(function(a,b){return a+b;});
              slicedBusUnitCount.push(sumTheOthers);
              makeChart(slicedBusUnit, slicedBusUnitCount, chartId);
            },
            error: function(data, errorCode, errorMessage) {
              $("#container").html(errorMessage + errorCode);
              console.log("MAJOR ERROR");
            }
          }); // END Ajax call
        } // END updateBusUnitCount();

        // Ticket Count by Priority
        function updateTicketCount(locationFilter, locationPrefix) {
          var priorities = [
            "(1) Critical",
            "(2) High",
            "(3) Medium",
            "(4) Low"
          ];
          var elementIDs = [
            "_critical_priority",
            "_high_priority",
            "_medium_priority",
            "_low_priority"
          ];
          $.ajax({
            url: "http://webshare/departments/it/_api/Lists/getbytitle('IT%20Helpdesk')/items?$select=Title,Priority,OData__Status&$filter=(OData__Status ne 'Closed') and " + locationFilter,
            type: "GET",
            // dataType: "json",
            timeout: 3000,
            headers: {
                accept: "application/json;odata=verbose",
                contentType: "application/json;odata=verbose"
            },
            success: function (data) {
                // you can find the items in JSON format under data.results
                var priorityCounts = {};
                var results = data.d.results;
                // Count the tickets, accumulating by priority.
                for (var i = 0; i < results.length; i++) {
                  var result = results[i];
                  var priority = result.Priority;
                  priorityCounts[priority] = priorityCounts[priority] ? priorityCounts[priority]+1 : 1;
                }
                // Make sure all priorities have a number value, including 0
                // The updates the html with the count for each priority.
                for (var i = 0; i < priorities.length; i++) {
                  var priorityString = priorities[i];
                  priorityCounts[priorityString] = priorityCounts[priorityString] ? priorityCounts[priorityString] : 0;
                  $("#" + locationPrefix + elementIDs[i]).html(priorityCounts[priorityString]);
                }
            },
            error: function (data, errorCode, errorMessage) {
                // error handling
                for (var priority in bbmrPriorities) {
                  $(priority).html('Error');
                }
            }
          });
        }


        function makeChart(labels, data, elementID) {
          var ctx = document.getElementById(elementID);
          var myChart = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: labels,
                datasets: [{
                  data: data,
                  backgroundColor: [
                    "#FF1C09",
                    "#E87008",
                    "#FFC503",
                    "#7de808",
                    "#4fbb0c",
                    "#0c8c2d",
                    "#0c7a8c"
                  ],
                }]
              },
              options: {
                rotation:280
              }
            });
          }

          function getTheFirst() {
            var d = new Date();
            d.setUTCDate(1);
            d.setUTCHours(0);
            d.setUTCMinutes(0);
            d.setUTCSeconds(0);
            d.setUTCMilliseconds(0);
            return d.toISOString();
          }

          function getDaysAgo(n) {
            var d = new Date();
            d.setDate(d.getDate() - n);
            return d.toISOString();
          }
      </script>
    </div>
  </div>
</div>
